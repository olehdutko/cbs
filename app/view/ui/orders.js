/*
 * File: app/view/ui/orders.js
 * Date: Mon Sep 12 2011 16:32:25 GMT+0300 (FLE Daylight Time)
 *
 * This file was generated by Ext Designer version 1.2.0.
 * http://www.sencha.com/products/designer/
 *
 * This file will be auto-generated each and everytime you export.
 *
 * Do NOT hand edit this file.
 */
Ext.Loader.setConfig({enabled: true});
Ext.grid.RowEditor.prototype.cancelBtnText = "Відмінити";
Ext.grid.RowEditor.prototype.saveBtnText = "Зберегти";
Ext.grid.RowEditor = new Ext.grid.RowEditor();
Ext.Loader.setPath('Ext.ux', '/ext-4.0.2a/examples/ux');
Ext.require([
    //'Ext.grid.*',
    //'Ext.data.*',
    'Ext.ux.grid.FiltersFeature',
    'Ext.toolbar.Paging'
]);
var winVydaty;
var winInfo;
//var currentOrderId;

var url = {
        local:  'grid-filter.json',  
        remote: 'grid-filter.php'
    };

    var encode = false;
    var local = false;
	
	 Ext.define('Product', {
    extend: 'Ext.data.Model',
    fields: [ 
			{ type: 'int', name: 'order_id' },
			{ type: 'date',name: 'date' },
			{ type: 'string', name: 'name1' },
			{ type: 'string',name: 'name2' },
			{ type: 'string',name: 'surname' },
			{ type: 'string',name: 'email' },
			{ type: 'string', name: 'idcard' },
			{ type: 'string', name: 'notes' },
			{ type: 'string',name: 'status' }
			]
});

	
	
    var filters = {
        ftype: 'filters',
        encode: encode, 
        local: local,   

        filters: [
			
			{ type: 'int', dataIndex: 'order_id' },
			{ type: 'date', dataIndex: 'date' },
			{ type: 'string',dataIndex: 'name1' },
			{ type: 'string',dataIndex: 'name2' },
			{ type: 'string',dataIndex: 'surname' },
			{ type: 'string',dataIndex: 'email' },
			{ type: 'string', dataIndex: 'idcard' },
			{ type: 'string', dataIndex: 'notes' },
			{ type: 'string',dataIndex: 'status' }
        ]
    };
/*	
	ordersAll = Ext.create('Ext.data.JsonStore', {
	autoLoad: true,
	 pageSize: 20,
            autoSync: true,
            storeId: 'ordersAll',
            proxy: {
                type: 'ajax',
                url: './php/ordersAll.php',
                reader: {
                    type: 'json',
                    root: 'data'
                }
            },
            fields: [
			{ name: 'order_id' },
			{ name: 'date' },
			{ name: 'name1' },
			{ name: 'name2' },
			{ name: 'surname' },
			{ name: 'email' },
			{ name: 'idcard' },
			{ name: 'notes' },
			{ name: 'status' },
			{ name: 'isdeleted' }

            ]
    });
	ordersNew = Ext.create('Ext.data.JsonStore', {
	autoLoad: true,
	 pageSize: 20,
            autoSync: true,
            storeId: 'ordersNew',
            proxy: {
                type: 'ajax',
                url: './php/ordersNew.php',
                reader: {
                    type: 'json',
                    root: 'data'
                }
            },
            fields: [
			{ name: 'order_id' },
			{ name: 'date' },
			{ name: 'name1' },
			{ name: 'name2' },
			{ name: 'surname' },
			{ name: 'email' },
			{ name: 'idcard' },
			{ name: 'notes' },
			{ name: 'status' },
			{ name: 'isdeleted' }

            ]
    });
	ordersArchieved = Ext.create('Ext.data.JsonStore', {
	autoLoad: true,
	 pageSize: 20,
            autoSync: true,
            storeId: 'ordersArchieved',
            proxy: {
                type: 'ajax',
                url: './php/ordersArchieved.php',
                reader: {
                    type: 'json',
                    root: 'data'
                }
            },
            fields: [
			{ name: 'order_id' },
			{ name: 'date' },
			{ name: 'name1' },
			{ name: 'name2' },
			{ name: 'surname' },
			{ name: 'email' },
			{ name: 'idcard' },
			{ name: 'notes' },
			{ name: 'status' },
			{ name: 'isdeleted' }

            ]
    });
	ordersDone = Ext.create('Ext.data.JsonStore', {
	autoLoad: true,
	 pageSize: 20,
            autoSync: true,
            storeId: 'ordersDone',
            proxy: {
                type: 'ajax',
                url: './php/ordersDone.php',
                reader: {
                    type: 'json',
                    root: 'data'
                }
            },
            fields: [
			{ name: 'order_id' },
			{ name: 'date' },
			{ name: 'name1' },
			{ name: 'name2' },
			{ name: 'surname' },
			{ name: 'email' },
			{ name: 'idcard' },
			{ name: 'notes' },
			{ name: 'status' },
			{ name: 'isdeleted' }

            ]
    });
	ordersDeleted = Ext.create('Ext.data.JsonStore', {
	autoLoad: true,
	 pageSize: 20,
            autoSync: true,
            storeId: 'ordersDeleted',
            proxy: {
                type: 'ajax',
                url: './php/ordersDeleted.php',
                reader: {
                    type: 'json',
                    root: 'data'
                }
            },
            fields: [
			{ name: 'order_id' },
			{ name: 'date' },
			{ name: 'name1' },
			{ name: 'name2' },
			{ name: 'surname' },
			{ name: 'email' },
			{ name: 'idcard' },
			{ name: 'notes' },
			{ name: 'status' },
			{ name: 'isdeleted' }

            ]
    });
*/
	
	ordered = Ext.create('Ext.data.JsonStore', {
	autoLoad: false,
	 pageSize: 20,
            autoSync: true,
            storeId: 'ordered',
            proxy: {
                type: 'ajax',
                url: './php/ordered.php',
                reader: {
                    type: 'json',
                    root: 'data'
                }
            },
            fields: [
			{ name: 'id' },
			{ name: 'order_id' },
			{ name: 'book_id' }
            ]
    });
	
CurrentStore = 'ordersAll';	

Ext.define('Borsuko.view.ui.orders', {
    extend: 'Ext.panel.Panel',


    initComponent: function() {
        var me = this;
        me.items = [
            {
                xtype: 'form',
                autoRender: true,
                autoShow: true,
                frame: true,
                height: 750,
                id: 'tabs',
                itemId: 'tabs',
                maintainFlex: true,
                bodyPadding: '',
                animCollapse: false,
                collapseFirst: false,
                collapsed: false,
                collapsible: true,
                frameHeader: false,
                title: 'Замовлення',
                titleCollapse: true,
                pollForChanges: true,
                paramsAsHash: true,
                standardSubmit: true,
                trackResetOnLoad: true,
                items: [
				{
                        xtype: 'gridpanel',
                        id: "orders",
						height: 400,
                        bodyBorder: true,
                        frameHeader: false,
                        store: CurrentStore,
						selModel: Ext.create('Ext.selection.RowModel', {
                            allowDeselect: true
                        }),
                        columnLines: true,
                        features: [filters],
                        		columns: [
                            {
                                xtype: 'gridcolumn',
								width: 50,
								//width: 41,
                                autoRender: true,
                                layout: {
                                    type: 'fit'
                                },
                                dataIndex: 'order_id',
                                text: 'Номер',
								filtrable:true,
								renderer: GreenGrtayColor
                            },
                            {
                                xtype: 'gridcolumn',
								width: 150,
								//width: 41,
                                dataIndex: 'date',
                                text: 'Дата замовлення',
								renderer: GreenGrtayColor
                            },
                            {
                                xtype: 'gridcolumn',
								width: 150,
								//width: 41,
                                dataIndex: 'name1',
                                text: 'Ім\'я',
								renderer: GreenGrtayColor
                            },
                            {
                                xtype: 'gridcolumn',
								width: 150,
                                dataIndex: 'name2',
                                text: 'Прізвище',
								renderer: GreenGrtayColor
                            },
                            {
                                xtype: 'gridcolumn',
								width: 150,
                                dataIndex: 'surname',
                                text: 'По-батькові',
								renderer: GreenGrtayColor
                            },
                            {
                                xtype: 'gridcolumn',
								width: 100,
                                dataIndex: 'email',
                                text: 'Електронна Пошта',
								renderer: GreenGrtayColor
                            },
                            {
                                xtype: 'gridcolumn',
								width: 100,
                                dataIndex: 'idcard',
                                text: 'Номер читацького/Студентського',
								renderer: GreenGrtayColor
                            },
							{
                                xtype: 'gridcolumn',
								width: 100,
                                dataIndex: 'notes',
                                text: 'Примітка',
								renderer: GreenGrtayColor
                            },
							{
                                xtype: 'gridcolumn',
								width: 100,
                                dataIndex: 'status',
                                text: 'Статус',
								renderer: GreenGrtayColor
                            }
                          ],

						 listeners: {
							selectionchange: function(model, records) {
								if (records[0]) {
									var orderedGrid = Ext.getCmp('orderedGrid').getView();
									var order_id = records[0].raw.order_id;
									orderedGrid.getStore().load({ params:{order_id: order_id} });
								}
							}
						},
						
                        viewConfig: {
                            width: 2000
                        },
						 dockedItems: [
							{
                                xtype: 'toolbar',
								id: 'toolbarTopOrders',
                                dock: 'top',
                                items: [ 
								{
									xtype: 'combobox',
									id: 'books_tatus_toolbar',
									name: 'books_tatus_toolbar',
									emptyText: 'Статус',
									editable: false,
									displayField: 'order_status',
									fieldLabel: 'Статус',
									queryMode: 'local',
									store: 'orders_statuses',
									valueField: 'order_status_id',
									listeners: {
										select: {
											fn:function(combo, value) 
											{
												switch (combo.value)
												{
												
												case "0":
												CurrentStore = Ext.getStore('ordersAll');
													Ext.getCmp('orders').view.store = CurrentStore;
													Ext.getCmp('orders').view.refresh();
													Ext.getCmp("pagingtoolbar").bind("ordersAll");
													Ext.getCmp("pagingtoolbar").doRefresh();
													//Ext.getCmp('vydaty').setDisabled(false)
													//Ext.getCmp('info').setDisabled(false)
													break;
												case "1":
												CurrentStore = Ext.getStore('ordersNew');
													Ext.getCmp('orders').view.store = CurrentStore;
													Ext.getCmp('orders').view.refresh();
													Ext.getCmp("pagingtoolbar").bind("ordersNew");
													Ext.getCmp("pagingtoolbar").doRefresh();
													//Ext.getCmp('vydaty').setDisabled(true)
													//Ext.getCmp('info').setDisabled(true)
													break;
												case "2":
												CurrentStore = Ext.getStore('ordersArchieved');
													Ext.getCmp('orders').view.store = CurrentStore;
													Ext.getCmp('orders').view.refresh();
													Ext.getCmp("pagingtoolbar").bind("ordersArchieved");
													Ext.getCmp("pagingtoolbar").doRefresh();
													//Ext.getCmp('vydaty').setDisabled(true)
													//Ext.getCmp('info').setDisabled(true)
													break;
												case "3":
												CurrentStore = Ext.getStore('ordersDeleted');
													Ext.getCmp('orders').view.store = CurrentStore;
													Ext.getCmp('orders').view.refresh();
													Ext.getCmp("pagingtoolbar").bind("ordersDeleted");
													Ext.getCmp("pagingtoolbar").doRefresh();
													////Ext.getCmp('vydaty').setDisabled(true)
													//Ext.getCmp('info').setDisabled(true)
													break;
												case "4":
												CurrentStore = Ext.getStore('ordersDone');
													Ext.getCmp('orders').view.store = CurrentStore;
													Ext.getCmp('orders').view.refresh();
													Ext.getCmp("pagingtoolbar").bind("ordersDone");
													Ext.getCmp("pagingtoolbar").doRefresh();
													////Ext.getCmp('vydaty').setDisabled(true)
													//Ext.getCmp('info').setDisabled(true)
													break;
												};
											}
										}
									}
								},
								
								{
									xtype: 'button',
									id: 'add',
									text: 'Виконати',
									iconCls: 'add',
									handler : function(){
									MakeDone();
									}
								}
							]
                            },
							{
                                xtype: 'pagingtoolbar',
								pageSize: 20,
								id: 'pagingtoolbar',
                                afterPageText: 'із {0}',
                                beforePageText: 'Сторінка',
                                displayInfo: true,
                                displayMsg: 'Показано {0} - {1} із {2}',
                                emptyMsg: 'Записи відсутні',
                                firstText: 'Перша сторінка',
                                lastText: 'Остання сторінка',
                                nextText: 'Наступна сторінка',
                                prependButtons: true,
                                prevText: 'Попередня сторінка',
                                refreshText: 'Оновити',
								store: 'ordersAll',
                                dock: 'bottom'
                            }
                        ]
				
                    },
                    {
                        xtype: 'gridpanel',
                        id: 'orderedGrid',
						height: 400,
                        bodyBorder: true,
                        frameHeader: false,
                        store: 'ordered',
						selModel: Ext.create('Ext.selection.RowModel', {
                            allowDeselect: true
                        }),
                        columnLines: true,
                        features: [filters],
                        		columns: [
                            /*{
                                xtype: 'gridcolumn',
								width: 150,
                                dataIndex: 'State',
                                text: 'Стан книжки',
                                field: {
									 xtype: 'combobox',
									 editable: false,
									displayField: 'name',
									queryMode: 'local',
									store: 'StanObjektu',
									valueField: 'abbr'
                                    
                                },
									renderer: function(v, params, record) 	{ 
								if(record.data.State	 == '1') { 
								var stan = 'відкр.';
								var color = 'green';
								};
								if(record.data.State	 == '0') { 
								var stan = 'закр.';
								var color = 'gray'; var dekor =  'line-through';
								};
								return '<span style="color:' + color + '">' + stan + '</span>';
								}
                            },*/
                            {
                                xtype: 'gridcolumn',
								width: 50,
								//width: 41,
                                autoRender: true,
                                layout: {
                                    type: 'fit'
                                },
                                dataIndex: 'id',
                                text: 'Номер',
								filtrable:true,
								renderer: GreenGrtayColor
                            },
                            {
                                xtype: 'gridcolumn',
								width: 150,
								//width: 41,
                                dataIndex: 'order_id',
                                text: 'order_id',
								renderer: GreenGrtayColor
                            },
							{
                                xtype: 'gridcolumn',
								width: 150,
								//width: 41,
                                dataIndex: 'book_id',
                                text: 'book_id',
								renderer: GreenGrtayColor
                            },
							{
                                xtype: 'gridcolumn',
								width: 150,
								//width: 41,
                                dataIndex: 'book_name',
                                text: 'Назва Книги',
								renderer: GreenGrtayColor
                            },
							{
                                xtype: 'gridcolumn',
								width: 150,
								//width: 41,
                                dataIndex: 'book_outhor',
                                text: 'Автор',
								renderer: GreenGrtayColor
                            },
							{
                                xtype: 'gridcolumn',
								width: 150,
								//width: 41,
                                dataIndex: 'year',
                                text: 'Рік',
								renderer: GreenGrtayColor
                            },
							{
                                xtype: 'gridcolumn',
								width: 150,
								//width: 41,
                                dataIndex: 'publisher',
                                text: 'Видавець',
								renderer: GreenGrtayColor
                            }
                          ],

						  listeners: {
							/*selectionchange: function(model, records) {
								if (records[0]) {
									var book_id = Ext.getCmp(GridName).getSelectionModel().selected.items[0].raw.id;
									bookInfoGrid.getStore().load({ params:{book_id: book_id} });
								}
							}*/
						},
                        viewConfig: {
                            width: 2000
                        },
						 dockedItems: [
							{
                                xtype: 'toolbar',
								id: 'toolbarTop',
                                dock: 'top',
                                items: [ 
								/*{
									xtype: 'button',
									id: 'add',
									text: 'Замовити',
									iconCls: 'add',
									handler : function(){
									Order();
									}
								},
								{
									xtype: 'button',
									id: 'check',
									text: 'Перевірити',
									iconCls: 'check',
									handler : function(){
									CheckVisitor();
									}
								},*/
							]
                            },
							{
                                xtype: 'pagingtoolbar',
								pageSize: 20,
								id: 'pagingtoolbar',
                                afterPageText: 'із {0}',
                                beforePageText: 'Сторінка',
                                displayInfo: true,
                                displayMsg: 'Показано {0} - {1} із {2}',
                                emptyMsg: 'Записи відсутні',
                                firstText: 'Перша сторінка',
                                lastText: 'Остання сторінка',
                                nextText: 'Наступна сторінка',
                                prependButtons: true,
                                prevText: 'Попередня сторінка',
                                refreshText: 'Оновити',
								store: 'ordered',
                                dock: 'bottom'
                            }
                        ]
				
                    }
                ]
            }
        ];
        me.callParent(arguments);
    }
});


function CheckVisitor(){		
		var str_idcard = Ext.getCmp("idcard").getValue();
		Ext.Ajax.request(
	{
		url: './php/check_visitor.php',
		params: {
				idcard: str_idcard
		},
		callback: function(options, success, response) {
				var responseObj = JSON.parse(response.responseText);

			if (responseObj.total == 1) {
				
				Ext.getCmp("name1").reset();
				Ext.getCmp("name2").reset();
				Ext.getCmp("surname").reset();
				Ext.getCmp("email").reset();
				Ext.getCmp("name1").setValue(responseObj.data[0].name1);
				Ext.getCmp("name2").setValue(responseObj.data[0].name2);
				Ext.getCmp("surname").setValue(responseObj.data[0].surname);
				Ext.getCmp("email").setValue(responseObj.data[0].email);
			}
			else{
				Ext.Msg.confirm('Читача в Базі не знайдено', 'Чи бажаєте зареєструвати нового читача?',
				function(btn){
					if(btn == 'yes'){
						
						window.open(
						  './add_reader.php?readerid='+str_idcard,
						  '_blank' // <- This is what makes it open in a new window.
						);

					}
				}
				);
				
									
			}

			},
		success: function() {},
		failure: function(response)
		{
			Ext.MessageBox.alert('Помилка', 'Неможливо доступитися до бази даних');
		}
	})
		
	
	}

function MakeDone(){
		var MyGrid = Ext.getCmp('orders').getView();
		var cr = Ext.getCmp('orders').getSelectionModel().selected;
		var order_id = cr.items[0].data.order_id;
		Ext.Ajax.request({
			url:'/php/makedone.php',
			params: {order_id: order_id},
			success:function(responce, action) {
				MyGrid.getStore().load();
			},
			failure: function(form, action) {
				//alert('Помилка при виделенні');
			}
		});
    }

function Order(){		
	
		var id = Ext.getCmp("id").getValue();
		var date = Ext.getCmp("date").getValue();
		var name1 = Ext.getCmp("name1").getValue();
		var name2 = Ext.getCmp("name2").getValue();
		var surname = Ext.getCmp("surname").getValue();
		var email = Ext.getCmp("email").getValue();
		var idcard = Ext.getCmp("idcard").getValue();
		var notes = Ext.getCmp("notes").getValue();
		var selection =  Ext.getCmp('Orders').getSelectionModel().selected;
		var Slenght = selection.length;
		var currentOrderId = Ext.getCmp("id").getValue();
	
	
	Ext.Ajax.request(
	{
		url: './php/check_visitor.php',
		params: {
				idcard: idcard
		},
		callback: function(options, success, response) {
				var responseObj = JSON.parse(response.responseText);

			if (responseObj.total == 1) {
/*******************************************додаю замовлення*******************************************/
				Ext.Ajax.request({
				url: './php/InsertOrder.php',
				
				params: 
					{
						id:id,
						date:date,
						name1:name1,
						name2:name2,
						surname:surname,
						email:email,
						idcard:idcard,
						notes:notes
					},
					/*callback: function(options, success, response) {
						currentOrderId = response.responseText;
					},*/
					success: function()
					{
						//var MyGrid = Ext.getCmp(GridName).getView();
						//MyGrid.getStore().load();				
					},
					failure: function(response)
					{
						Ext.MessageBox.alert('Помилка', 'Неможливо доступитися до бази даних');
					}
				});
/*******************************************додаю книги до замовлення*******************************************/	

		if(Slenght > 0) {
			
			for (var i=0 ; i<Slenght; i++)
			{
				var book_id = selection.items[i].data.id;
				Ext.Ajax.request({
				url: './php/InsertOrdered.php',
				params: 
					{
						book_id:book_id,
						currentOrderId:currentOrderId
					},
					success: function()
					{
					},
					failure: function(response)
					{
						Ext.MessageBox.alert('Помилка', 'Неможливо доступитися до бази даних');
					}
				});
			}
			var MyGrid = Ext.getCmp('Orders').getView();
			MyGrid.getStore().load();	
		}
		else {Ext.MessageBox.alert('Message', 'Будьласка, добавте книги до замовлення!');}
		
				
			}
			else{
				Ext.Msg.alert('Помилка', 'такого читача в Базі не знайдено!');
			}

		},
		success: function() {},
		failure: function(response)
		{
			Ext.MessageBox.alert('Помилка', 'Неможливо доступитися до бази даних');
		}
	})
	
	
    }

function GreenGrtayColor (v, params, record) { 
	
	if(record.data.status	 == 'Нове') { 
		var color = 'blue'; 
		var dekor =  'none';
	};
	
	if(record.data.status	 == 'Виконане') { 
		var color = 'green'; 
		var dekor =  'none';
	};
	
	if(record.data.status	 == 'Видалене') { 
		var color = 'black'; 
		var dekor =  'line-through';
	};
	
	return '<span style="color:' + color + ';text-decoration:' + dekor + '">' + v + '</span>';
}


function checker(stridcard) {
	var resp;
	Ext.Ajax.request(
	{
		url: './php/check_visitor.php',
		async   : false,
		params: {
				idcard: stridcard
		},
		callback: function(options, success, response) {
			resp = JSON.parse(response.responseText).total;
		},
		success: function() 
		{
			
		},
		failure: function(response)
		{
			Ext.MessageBox.alert('Помилка', 'Неможливо доступитися до бази даних');
		}
	})	
	
	return resp;
						
}




	
						